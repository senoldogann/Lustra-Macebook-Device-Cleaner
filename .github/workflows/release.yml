name: Release Production

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    name: Build & Release
    runs-on: macos-15
    
    permissions:
      contents: write

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      
    - name: Select Xcode 16
      run: sudo xcode-select -s /Applications/Xcode_16.0.app/Contents/Developer
      
    - name: Import Signing Certificate
      env:
        BUILD_CERTIFICATE_BASE64: ${{ secrets.MACOS_CERTIFICATE }}
        P12_PASSWORD: ${{ secrets.MACOS_CERTIFICATE_PASSWORD }}
        KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
      run: |
        if [ -z "$BUILD_CERTIFICATE_BASE64" ]; then
          echo "âš ï¸ No Certificate found. Building Ad-Hoc signed app."
          echo "CODE_SIGN_IDENTITY=-" >> $GITHUB_ENV
          echo "CODE_SIGNING_REQUIRED=YES" >> $GITHUB_ENV
        else
          echo "ðŸ” Importing Certificate..."
          # Create Keychains
          CERTIFICATE_PATH=$RUNNER_TEMP/build_certificate.p12
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          
          # Decode cert
          echo -n "$BUILD_CERTIFICATE_BASE64" | base64 --decode -o $CERTIFICATE_PATH
          
          # Create temporary keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          
          # Import cert
          security import $CERTIFICATE_PATH -P "$P12_PASSWORD" -A -t agg -k $KEYCHAIN_PATH
          security list-keychains -s $KEYCHAIN_PATH
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          
          echo "CODE_SIGN_IDENTITY=Developer ID Application" >> $GITHUB_ENV
          echo "CODE_SIGNING_REQUIRED=YES" >> $GITHUB_ENV
        fi

    - name: Build & Package DMG
      run: |
        chmod +x scripts/create_dmg.sh
        ./scripts/create_dmg.sh
      env:
        CODE_SIGN_IDENTITY: ${{ env.CODE_SIGN_IDENTITY }}
        CODE_SIGNING_REQUIRED: ${{ env.CODE_SIGNING_REQUIRED }}

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: Lustra_Installer.dmg
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
